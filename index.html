<!DOCTYPE html>
<html lang="en">

<head>
     <meta charset="UTF-8" />
     <title>Tailscale Servers Dashboard</title>
     <style>
          /* Basic reset and some styling */
          * {
               box-sizing: border-box;
               margin: 0;
               padding: 0;
          }

          body {
               font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
               padding: 32px;
               background: #f8fafc;
               color: #1e293b;
               line-height: 1.5;
          }

          h1 {
               margin-bottom: 1.5rem;
               font-size: 2rem;
               font-weight: 600;
               color: #0f172a;
          }

          /* Container for the entire dashboard */
          .dashboard {
               max-width: 1400px;
               margin: 0 auto;
          }

          /* Section */
          .section {
               background: #ffffff;
               border-radius: 12px;
               padding: 1.5rem;
               margin-bottom: 1.5rem;
               box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
               border: 1px solid rgba(0, 0, 0, 0.05);
               transition: all 0.2s ease;
          }

          .section:hover {
               box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
          }

          .section-header {
               display: flex;
               justify-content: space-between;
               align-items: center;
               margin-bottom: 1rem;
          }

          .section h2 {
               font-size: 1.25rem;
               font-weight: 600;
               color: #0f172a;
          }

          .remove-section-btn {
               background: #ef4444;
               color: #fff;
               border: none;
               padding: 0.5rem 1rem;
               border-radius: 6px;
               cursor: pointer;
               font-weight: 500;
               transition: background 0.2s ease;
          }

          .remove-section-btn:hover {
               background: #dc2626;
          }

          /* Cards container - 5 cards per row using a CSS grid */
          .cards-container {
               display: grid;
               grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
               gap: 1rem;
          }

          /* Each card */
          .card {
               background: #ffffff;
               border: 1px solid rgba(0, 0, 0, 0.05);
               border-radius: 8px;
               padding: 1.25rem;
               text-align: center;
               transition: all 0.2s ease;
               display: flex;
               flex-direction: column;
               align-items: center;
               box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
               position: relative;
          }

          .card:hover {
               transform: translateY(-2px);
               box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
          }

          .card img {
               width: 48px;
               height: 48px;
               margin-bottom: 1rem;
               border-radius: 8px;
          }

          .card-title {
               font-weight: 600;
               margin: 0.5rem 0;
               color: #0f172a;
          }

          .card-link {
               background: #3b82f6;
               color: #ffffff;
               text-decoration: none;
               padding: 0.5rem 1rem;
               border-radius: 6px;
               font-weight: 500;
               margin: 0.75rem 0;
               transition: background 0.2s ease;
               width: 100%;
          }

          .card-link:hover {
               background: #2563eb;
               text-decoration: none;
          }

          .remove-card-btn {
               background: #ef4444;
               color: #fff;
               border: none;
               padding: 0.4rem 0.8rem;
               border-radius: 6px;
               cursor: pointer;
               font-size: 0.875rem;
               margin-top: 0.5rem;
               width: 100%;
               transition: background 0.2s ease;
          }

          .remove-card-btn:hover {
               background: #dc2626;
          }

          /* Add Section form */
          #add-section-form {
               margin-bottom: 2rem;
               display: flex;
               gap: 1rem;
               max-width: 600px;
          }

          #add-section-form input[type="text"] {
               flex: 1;
               padding: 0.75rem 1rem;
               font-size: 1rem;
               border: 1px solid #e2e8f0;
               border-radius: 6px;
               outline: none;
               transition: border-color 0.2s ease;
          }

          #add-section-form input[type="text"]:focus {
               border-color: #3b82f6;
               box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
          }

          #add-section-form button {
               padding: 0.75rem 1.5rem;
               background: #3b82f6;
               color: #ffffff;
               border: none;
               border-radius: 6px;
               font-weight: 500;
               cursor: pointer;
               transition: background 0.2s ease;
          }

          #add-section-form button:hover {
               background: #2563eb;
          }

          /* Add card form inside each section (hidden by default, toggles on button click) */
          .add-card-form {
               margin: 1rem 0;
               display: none;
          }

          .new-card {
               background: #ffffff;
               border: 1px solid rgba(0, 0, 0, 0.1);
               border-radius: 8px;
               padding: 1.25rem;
               max-width: 400px;
               margin: 0 auto;
          }

          .card-input {
               width: 100%;
               padding: 0.75rem;
               margin-bottom: 1rem;
               border: 1px solid #e2e8f0;
               border-radius: 6px;
               font-size: 0.875rem;
          }

          .card-input:focus {
               outline: none;
               border-color: #3b82f6;
               box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
          }

          .icon-selector {
               margin-bottom: 1rem;
          }

          .icon-preview {
               height: 48px;
               display: flex;
               align-items: center;
               justify-content: center;
               margin-top: 0.5rem;
          }

          .form-buttons {
               display: flex;
               gap: 0.5rem;
          }

          .submit-card-btn, .cancel-card-btn {
               padding: 0.75rem 1rem;
               border-radius: 6px;
               font-weight: 500;
               cursor: pointer;
               flex: 1;
          }

          .submit-card-btn {
               background: #3b82f6;
               color: #ffffff;
               border: none;
          }

          .cancel-card-btn {
               background: #f1f5f9;
               color: #64748b;
               border: 1px solid #e2e8f0;
          }

          .submit-card-btn:hover {
               background: #2563eb;
          }

          .cancel-card-btn:hover {
               background: #e2e8f0;
          }

          .show-add-card-form-btn {
               background: #3b82f6;
               color: #ffffff;
               border: none;
               padding: 0.75rem 1rem;
               border-radius: 6px;
               cursor: pointer;
               font-weight: 500;
               margin-bottom: 1rem;
               transition: background 0.2s ease;
          }

          .show-add-card-form-btn:hover {
               background: #2563eb;
          }

          .edit-section-btn, .edit-card-btn {
               background: #0ea5e9;
               color: #fff;
               border: none;
               padding: 0.5rem 1rem;
               border-radius: 6px;
               cursor: pointer;
               font-weight: 500;
               transition: background 0.2s ease;
               margin-right: 0.5rem;
          }

          .edit-section-btn:hover, .edit-card-btn:hover {
               background: #0284c7;
          }

          .edit-card-btn {
               width: 100%;
               margin: 0.5rem 0;
          }

          /* Add these styles to your existing CSS */
          .dropdown {
               position: relative;
               display: inline-block;
          }

          .dropdown-toggle {
               background: transparent;
               border: none;
               color: #64748b;
               cursor: pointer;
               padding: 0.5rem;
               border-radius: 4px;
          }

          .dropdown-toggle:hover {
               background: #f1f5f9;
          }

          .dropdown-toggle svg {
               width: 16px;
               height: 16px;
          }

          .dropdown-menu {
               position: absolute;
               right: 0;
               top: 100%;
               background: white;
               border: 1px solid #e2e8f0;
               border-radius: 6px;
               box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
               display: none;
               z-index: 100;
               min-width: 120px;
          }

          .dropdown-menu.show {
               display: block;
          }

          .dropdown-item {
               display: block;
               padding: 0.5rem 1rem;
               color: #334155;
               text-decoration: none;
               cursor: pointer;
               width: 100%;
               text-align: left;
               border: none;
               background: none;
               font-size: 0.875rem;
          }

          .dropdown-item:hover {
               background: #f8fafc;
          }

          .dropdown-item.delete {
               color: #ef4444;
          }

          /* Remove old button styles */
          .remove-section-btn, .remove-card-btn, .edit-section-btn, .edit-card-btn {
               display: none;
          }

          /* Add to your existing styles */
          .header-container {
               display: flex;
               flex-direction: column;
               align-items: center;
               justify-content: center;
               gap: 1.5rem;
               margin-bottom: 2rem;
               text-align: center;
          }

          .save-dashboard-btn {
               background: #3b82f6;
               color: #ffffff;
               border: none;
               padding: 0.75rem 1.5rem;
               border-radius: 6px;
               font-weight: 500;
               cursor: pointer;
               transition: background 0.2s ease;
               margin-top: 20px;
          }

          .save-dashboard-btn:hover {
               background: #2563eb;
          }

          /* Add to your existing styles */
          .welcome-screen {
               display: flex;
               flex-direction: column;
               align-items: center;
               justify-content: center;
               min-height: 80vh;
               text-align: center;
          }

          .welcome-screen h1 {
               font-size: 2.5rem;
               color: #0f172a;
               margin-bottom: 1rem;
          }

          .welcome-screen p {
               color: #64748b;
               margin-bottom: 2rem;
          }

          .create-dashboard-btn {
               background: #3b82f6;
               color: white;
               border: none;
               width: 48px;
               height: 48px;
               border-radius: 24px;
               cursor: pointer;
               display: flex;
               align-items: center;
               justify-content: center;
               transition: transform 0.2s ease, background-color 0.2s ease;
          }

          .create-dashboard-btn:hover {
               background: #2563eb;
               transform: scale(1.1);
          }

          .dashboard-container {
               max-width: 1400px;
               margin: 0 auto;
               padding: 32px;
          }

          /* Update the dashboard title style */
          #dashboard-title {
               margin: 0;
               font-size: 2rem;
               color: #0f172a;
               font-weight: 600;
          }

          .icon-search-results {
               position: absolute;
               top: calc(100% + 4px);
               left: 0;
               right: 0;
               background: white;
               border: 1px solid #e2e8f0;
               border-radius: 6px;
               box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
               max-height: 200px;
               overflow-y: auto;
               display: none;
               z-index: 1000;
          }

          .icon-search-result {
               display: flex;
               align-items: center;
               padding: 0.75rem;
               cursor: pointer;
               gap: 0.75rem;
               border-bottom: 1px solid #f1f5f9;
          }

          .icon-search-result:last-child {
               border-bottom: none;
          }

          .icon-search-result:hover {
               background: #f8fafc;
          }

          .icon-preview-small {
               width: 24px;
               height: 24px;
               display: flex;
               align-items: center;
               justify-content: center;
          }

          .icon-preview {
               margin-top: 0.5rem;
               height: 60px;
               display: flex;
               align-items: center;
               justify-content: center;
               background: #f8fafc;
               border-radius: 6px;
               border: 1px dashed #e2e8f0;
          }

          .icon-preview img, .icon-preview svg {
               width: 48px;
               height: 48px;
               object-fit: contain;
          }

          .icon-search-result span {
               flex: 1;
               font-size: 0.875rem;
               color: #334155;
          }

          .icon-search-result {
               display: flex;
               align-items: center;
               padding: 0.75rem;
               cursor: pointer;
               gap: 0.75rem;
               border-bottom: 1px solid #f1f5f9;
          }

          .icon-preview-small {
               width: 24px;
               height: 24px;
               display: flex;
               align-items: center;
               justify-content: center;
          }

          .icon-preview-small svg {
               width: 100%;
               height: 100%;
          }

          .card-icon {
               width: 48px;
               height: 48px;
               margin: 0 auto 1rem auto;
               display: flex;
               align-items: center;
               justify-content: center;
          }

          .card-icon svg {
               width: 100%;
               height: 100%;
               object-fit: contain;
          }

          .card-icon img {
               width: 100%;
               height: 100%;
               object-fit: contain;
          }

          /* Update card styles */
          .card {
               background: #ffffff;
               border: 1px solid rgba(0, 0, 0, 0.05);
               border-radius: 8px;
               padding: 1.25rem;
               text-align: center;
               transition: all 0.2s ease;
               display: flex;
               flex-direction: column;
               align-items: center;
               box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
          }

          .card:hover {
               transform: translateY(-2px);
               box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
          }

          .card-content {
               display: flex;
               flex-direction: column;
               align-items: center;
               text-decoration: none;
               color: inherit;
               flex: 1;
               width: 100%;
          }

          .card-icon {
               width: 96px;  /* Doubled from 48px */
               height: 96px; /* Doubled from 48px */
               margin: 0 auto;
               display: flex;
               align-items: center;
               justify-content: center;
               transition: transform 0.2s ease;
          }

          .card-icon:hover {
               transform: scale(1.05);
          }

          .card-icon svg {
               width: 100%;
               height: 100%;
               object-fit: contain;
          }

          .card-icon img {
               width: 100%;
               height: 100%;
               object-fit: contain;
          }

          /* Only show title if there's no icon */
          .card:has(.card-icon) .card-title {
               display: none;
          }

          /* Only show link button if there's no icon */
          .card:has(.card-icon) .card-link {
               display: none;
          }

          /* Add dark mode styles */
          :root {
               --bg-color: #ffffff;
               --text-color: #0f172a;
               --card-bg: #ffffff;
               --border-color: rgba(0, 0, 0, 0.05);
               --dropdown-bg: #ffffff;
               --dropdown-hover: #f8fafc;
               --dropdown-icon-color: #64748b;  /* Default dropdown icon color */
          }

          .dark-mode {
               --bg-color: #202023;
               --text-color: #ffffff;
               --card-bg: #2d2d30;
               --border-color: rgba(255, 255, 255, 0.1);
               --dropdown-bg: #2d2d30;
               --dropdown-hover: #3d3d40;
               --dropdown-icon-color: #e98d3c;  /* Orange color for dark mode dropdowns */
          }

          body {
               background-color: var(--bg-color);
               color: var(--text-color);
               transition: background-color 0.3s ease, color 0.3s ease;
          }

          .card {
               background-color: var(--card-bg);
               border-color: var(--border-color);
          }

          /* Header dropdown styles */
          .header-dropdown {
               position: relative;
               display: inline-block;
          }

          .header-dropdown-toggle {
               background: transparent;
               border: none;
               color: #1e88e5;
               cursor: pointer;
               padding: 0.5rem;
               border-radius: 4px;
               display: flex;
               align-items: center;
               transition: transform 0.2s ease;
          }

          .header-dropdown-toggle:hover {
               transform: translateY(2px);
          }

          .header-dropdown-menu {
               position: absolute;
               right: 0;
               top: 100%;
               background: var(--dropdown-bg);
               border: 1px solid var(--border-color);
               border-radius: 6px;
               box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
               display: none;
               z-index: 100;
               min-width: 160px;
          }

          .header-dropdown-menu.show {
               display: block;
          }

          .header-dropdown-item {
               display: block;
               padding: 0.75rem 1rem;
               color: var(--text-color);
               text-decoration: none;
               cursor: pointer;
               width: 100%;
               text-align: left;
               border: none;
               background: none;
               font-size: 0.875rem;
               transition: background-color 0.2s ease;
          }

          .header-dropdown-item:hover {
               background-color: var(--dropdown-hover);
          }

          /* Update existing styles for dark mode */
          .section {
               background-color: var(--card-bg);
               border-color: var(--border-color);
          }

          .dropdown-menu {
               background-color: var(--dropdown-bg);
               border-color: var(--border-color);
          }

          .dropdown-item {
               color: var(--text-color);
          }

          .dropdown-item:hover {
               background-color: var(--dropdown-hover);
          }

          /* Update text colors for dark mode */
          .dark-mode #dashboard-title,
          .dark-mode .section h2,
          .dark-mode .card-title {
               color: var(--text-color);
          }

          /* Update dropdown styles */
          .dropdown-toggle {
               color: var(--dropdown-icon-color);
          }

          .header-dropdown-toggle {
               color: var(--dropdown-icon-color);
          }

          /* Update welcome screen for dark mode */
          .dark-mode .welcome-screen h1 {
               color: var(--text-color);
          }

          .dark-mode .welcome-screen p {
               color: #a1a1aa;  /* Lighter gray for dark mode secondary text */
          }

          /* Update form labels for dark mode */
          .dark-mode .form-field label {
               color: var(--text-color);
          }

          /* Update section headers for dark mode */
          .dark-mode .section-header h2 {
               color: var(--text-color);
          }

          /* Update dropdown menu items for dark mode */
          .dark-mode .dropdown-item,
          .dark-mode .header-dropdown-item {
               color: var(--text-color);
          }

          /* Keep the delete option red even in dark mode */
          .dark-mode .dropdown-item.delete {
               color: #ef4444;
          }

          /* Update card styles to position dropdown */
          .card {
               position: relative;
          }

          .card .dropdown {
               position: absolute;
               top: 8px;
               left: 8px;
               z-index: 10;
          }

          /* Make dropdown more visible on hover */
          .card .dropdown-toggle {
               opacity: 0.5;
               transition: opacity 0.2s ease;
          }

          .card:hover .dropdown-toggle {
               opacity: 1;
          }
     </style>
     <script type="application/json" id="dashboard-data">
          {
               "title": "",
               "sections": []
          }
     </script>
</head>

<body>
    <div id="welcome-screen" class="welcome-screen">
        <h1>Welcome to Cardy</h1>
        <p>Click the plus button to name your dashboard</p>
        <button id="create-dashboard-btn" class="create-dashboard-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>

    <div id="dashboard-container" class="dashboard-container" style="display: none;">
        <div class="header-container">
            <h1 id="dashboard-title"></h1>
        </div>
        
        <form id="add-section-form" style="display: none;">
            <input type="text" id="sectionName" placeholder="New Section Name" required />
            <button type="submit">Add Section</button>
        </form>

        <div id="dashboard" class="dashboard"></div>
    </div>

    <script>
        // Data structure for sections
        let sections = [];

        // Utility to create unique IDs
        function generateId() {
            return "_" + Math.random().toString(36).substr(2, 9);
        }

        // Load data function
        async function loadData() {
            try {
                // First try to load from cardy.json
                try {
                    console.log('Attempting to load from cardy.json...');
                    const response = await fetch('cardy.json');
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Successfully loaded from cardy.json:', data);
                        
                        if (data.sections.length > 0 || data.title) {
                            sections = data.sections;
                            document.getElementById('welcome-screen').style.display = 'none';
                            document.getElementById('dashboard-container').style.display = 'block';
                            document.getElementById('dashboard-title').textContent = data.title;
                            document.getElementById('add-section-form').style.display = 'flex';
                            setupAddSectionForm();
                            return true;
                        }
                    }
                } catch (e) {
                    console.log('No cardy.json found or error loading it:', e);
                }

                // If no cardy.json, try embedded JSON
                const dataScript = document.getElementById('dashboard-data');
                const embeddedData = JSON.parse(dataScript.textContent);
                if (embeddedData.sections.length > 0 || embeddedData.title) {
                    console.log('Loading from embedded JSON data');
                    sections = embeddedData.sections;
                    document.getElementById('welcome-screen').style.display = 'none';
                    document.getElementById('dashboard-container').style.display = 'block';
                    document.getElementById('dashboard-title').textContent = embeddedData.title;
                    document.getElementById('add-section-form').style.display = 'flex';
                    setupAddSectionForm();
                    return true;
                }

                // If no data found anywhere, we're in template mode
                console.log('No existing data found, starting in template mode');
                return false;

            } catch (e) {
                console.error('Error loading data:', e);
                sections = [];
                return false;
            }
        }

        // Save data function
        function saveData() {
            const data = {
                title: document.getElementById('dashboard-title').textContent,
                sections: sections
            };
            
            // Update the embedded JSON
            const dataScript = document.getElementById('dashboard-data');
            dataScript.textContent = JSON.stringify(data, null, 2);
            
            // Save to cardy.json
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cardy.json';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Add save button function
        function addSaveButton() {
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save Dashboard';
            saveButton.className = 'save-dashboard-btn';
            saveButton.onclick = saveData;
            
            const headerContainer = document.querySelector('.header-container');
            headerContainer.appendChild(saveButton);
        }

        // Make header editable function
        function makeHeaderEditable() {
            const headerContainer = document.querySelector('.header-container');
            headerContainer.style.display = 'flex';
            headerContainer.style.flexDirection = 'row';
            headerContainer.style.alignItems = 'center';
            headerContainer.style.justifyContent = 'center';
            headerContainer.style.gap = '20px';

            const titleDropdown = createHeaderDropdownMenu([
                {
                    label: 'Edit Title',
                    action: () => {
                        const newTitle = prompt('Enter new dashboard title:', document.getElementById('dashboard-title').textContent);
                        if (newTitle && newTitle.trim()) {
                            document.getElementById('dashboard-title').textContent = newTitle.trim();
                        }
                    }
                },
                {
                    label: 'Toggle Dark Mode',
                    action: toggleDarkMode
                },
                {
                    label: 'Save Dashboard',
                    action: saveData
                }
            ]);

            headerContainer.appendChild(titleDropdown);
        }

        // Add the header dropdown menu creation function
        function createHeaderDropdownMenu(items) {
            const dropdown = document.createElement('div');
            dropdown.className = 'header-dropdown';

            const toggleButton = document.createElement('button');
            toggleButton.className = 'header-dropdown-toggle';
            toggleButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            `;

            const menu = document.createElement('div');
            menu.className = 'header-dropdown-menu';

            items.forEach(item => {
                const button = document.createElement('button');
                button.className = 'header-dropdown-item';
                button.textContent = item.label;
                button.onclick = (e) => {
                    e.stopPropagation();
                    menu.classList.remove('show');
                    item.action();
                };
                menu.appendChild(button);
            });

            toggleButton.onclick = (e) => {
                e.stopPropagation();
                menu.classList.toggle('show');
            };

            document.addEventListener('click', () => {
                menu.classList.remove('show');
            });

            dropdown.appendChild(toggleButton);
            dropdown.appendChild(menu);
            return dropdown;
        }

        // Add dark mode toggle functionality
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // Initialize dashboard functionality
        function initializeDashboard() {
            const welcomeScreen = document.getElementById('welcome-screen');
            const dashboardContainer = document.getElementById('dashboard-container');
            const createDashboardBtn = document.getElementById('create-dashboard-btn');
            const addSectionForm = document.getElementById('add-section-form');
            
            createDashboardBtn.addEventListener('click', () => {
                const title = prompt('Enter your dashboard title:');
                if (title && title.trim()) {
                    // Hide welcome screen
                    welcomeScreen.style.display = 'none';
                    
                    // Show and setup dashboard
                    dashboardContainer.style.display = 'block';
                    document.getElementById('dashboard-title').textContent = title.trim();
                    
                    // Show add section form
                    addSectionForm.style.display = 'flex';
                    
                    // Setup edit button
                    makeHeaderEditable();
                    addSaveButton();
                    setupAddSectionForm();
                    
                    // Initialize empty dashboard
                    sections = [];
                    renderDashboard();
                }
            });
        }

        // Render dashboard function
        function renderDashboard() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section';
                sectionDiv.setAttribute('data-section-id', section.id);

                // Create section header
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                
                const sectionTitle = document.createElement('h2');
                sectionTitle.textContent = section.name;
                
                const sectionDropdown = createDropdownMenu([
                    {
                        label: 'Add Card',
                        action: () => {
                            // Show the add card form for this section
                            const addCardForm = sectionDiv.querySelector('.add-card-form');
                            addCardForm.style.display = 'flex';
                        }
                    },
                    {
                        label: 'Edit Section',
                        action: () => {
                            const newName = prompt("Enter new section name:", section.name);
                            if (newName && newName.trim()) {
                                editSection(section.id, newName.trim());
                            }
                        }
                    },
                    {
                        label: 'Remove Section',
                        class: 'delete',
                        action: () => removeSection(section.id)
                    }
                ]);

                sectionHeader.appendChild(sectionTitle);
                sectionHeader.appendChild(sectionDropdown);

                // Create cards container
                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'cards-container';

                // Add card form
                const addCardForm = document.createElement('form');
                addCardForm.className = 'add-card-form';
                addCardForm.style.display = 'none';
                addCardForm.innerHTML = `
                    <div class="card new-card">
                        <div class="form-field">
                            <label for="card-title-${section.id}">Service Name</label>
                            <input type="text" class="card-input" name="title" id="card-title-${section.id}" required>
                        </div>
                        
                        <div class="form-field">
                            <label for="card-link-${section.id}">Service URL</label>
                            <input type="text" class="card-input" name="link" id="card-link-${section.id}" 
                                   placeholder="http://, https://, or IP address" required>
                        </div>
                        
                        <div class="form-field">
                            <label for="card-icon-${section.id}">Service Icon</label>
                            <div class="icon-selector">
                                <input type="text" class="card-input" name="iconSearch" id="card-icon-${section.id}"
                                       placeholder="Start typing to search icons or enter URL..." 
                                       autocomplete="off">
                                <div class="icon-search-results"></div>
                                <div class="icon-preview"></div>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="submit" class="submit-card-btn">Add</button>
                            <button type="button" class="cancel-card-btn">Cancel</button>
                        </div>
                    </div>
                `;

                // Handle form submission
                addCardForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const cardData = {
                        title: formData.get('title'),
                        link: formData.get('link'),
                        icon: selectedIcon
                    };

                    if (cardData.title && cardData.link) {
                        addCard(section.id, cardData.title, cardData.link, cardData.icon);
                        addCardForm.style.display = 'none';
                        addCardForm.reset();
                    }
                });

                // Add this line here
                setupIconSearch(addCardForm);

                // Handle cancel button
                addCardForm.querySelector('.cancel-card-btn').addEventListener('click', () => {
                    addCardForm.style.display = 'none';
                    addCardForm.reset();
                });

                sectionDiv.appendChild(sectionHeader);
                sectionDiv.appendChild(addCardForm);
                sectionDiv.appendChild(cardsContainer);
                dashboard.appendChild(sectionDiv);

                // Render existing cards
                if (section.cards && section.cards.length > 0) {
                    section.cards.forEach(card => {
                        const cardElement = createCardElement(card, section.id);
                        cardsContainer.appendChild(cardElement);
                    });
                }
            });
        }

        // Add these helper functions for section operations
        function removeSection(sectionId) {
            sections = sections.filter(section => section.id !== sectionId);
            renderDashboard();
        }

        function editSection(sectionId, newName) {
            const section = sections.find(section => section.id === sectionId);
            if (section) {
                section.name = newName;
                renderDashboard();
            }
        }

        // Add the dropdown menu creation function if it's not already there
        function createDropdownMenu(items) {
            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown';

            const toggleButton = document.createElement('button');
            toggleButton.className = 'dropdown-toggle';
            toggleButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
            `;

            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';

            items.forEach(item => {
                const button = document.createElement('button');
                button.className = `dropdown-item ${item.class || ''}`;
                button.textContent = item.label;
                button.onclick = (e) => {
                    e.stopPropagation();
                    menu.classList.remove('show');
                    item.action();
                };
                menu.appendChild(button);
            });

            toggleButton.onclick = (e) => {
                e.stopPropagation();
                menu.classList.toggle('show');
            };

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                menu.classList.remove('show');
            });

            dropdown.appendChild(toggleButton);
            dropdown.appendChild(menu);
            return dropdown;
        }

        // Add this to your script section, before the DOMContentLoaded event listener
        function setupAddSectionForm() {
            const addSectionForm = document.getElementById('add-section-form');
            const sectionNameInput = document.getElementById('sectionName');

            addSectionForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent form submission from refreshing the page
                
                const sectionName = sectionNameInput.value.trim();
                if (sectionName) {
                    // Create new section
                    const newSection = {
                        id: generateId(),
                        name: sectionName,
                        cards: []
                    };
                    
                    // Add to sections array
                    sections.push(newSection);
                    
                    // Clear input
                    sectionNameInput.value = '';
                    
                    // Render dashboard
                    renderDashboard();
                }
            });
        }

        // Load icon index immediately
        async function loadIconIndex() {
            try {
                console.log('Attempting to load icon index...');
                const response = await fetch('assets/icon-index.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Successfully loaded icon index:', data);
                iconIndex = data.icons;
            } catch (error) {
                console.error('Error loading icon index:', error);
            }
        }

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
            
            await loadIconIndex();
            const hasExistingData = await loadData();
            if (!hasExistingData) {
                initializeDashboard();
            } else {
                makeHeaderEditable();
                renderDashboard();
            }
        });

        // Update the createCardElement function
        function createCardElement(card, sectionId) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';

            // Create clickable container for icon and title
            const clickableContainer = document.createElement('a');
            clickableContainer.href = card.link.startsWith('http') ? card.link : `http://${card.link}`;
            clickableContainer.target = '_blank';
            clickableContainer.rel = 'noopener noreferrer';
            clickableContainer.className = 'card-content';

            // Add icon if provided
            if (card.icon) {
                const iconContainer = document.createElement('div');
                iconContainer.className = 'card-icon';
                if (card.icon.type === 'url') {
                    iconContainer.innerHTML = `<img src="${card.icon.value}" alt="${card.title}">`;
                } else if (card.icon.type === 'svg') {
                    iconContainer.innerHTML = card.icon.value;
                }
                clickableContainer.appendChild(iconContainer);
            } else {
                // If no icon, show title and link button
                const titleEl = document.createElement('div');
                titleEl.className = 'card-title';
                titleEl.textContent = card.title;
                clickableContainer.appendChild(titleEl);

                const linkEl = document.createElement('a');
                linkEl.className = 'card-link';
                linkEl.href = card.link.startsWith('http') ? card.link : `http://${card.link}`;
                linkEl.target = '_blank';
                linkEl.rel = 'noopener noreferrer';
                linkEl.textContent = 'Open';
                cardDiv.appendChild(linkEl);
            }

            cardDiv.appendChild(clickableContainer);

            // Add dropdown menu
            const cardDropdown = createDropdownMenu([
                {
                    label: 'Edit',
                    action: () => {
                        const newTitle = prompt('Enter new title:', card.title);
                        const newLink = prompt('Enter new link:', card.link);
                        const newIcon = prompt('Enter new icon URL:', card.icon);
                        
                        if (newTitle && newTitle.trim()) {
                            editCard(sectionId, card.id, {
                                title: newTitle.trim(),
                                link: newLink ? newLink.trim() : card.link,
                                icon: newIcon ? newIcon.trim() : card.icon
                            });
                        }
                    }
                },
                {
                    label: 'Remove',
                    class: 'delete',
                    action: () => removeCard(sectionId, card.id)
                }
            ]);
            cardDiv.appendChild(cardDropdown);

            return cardDiv;
        }

        // Add the addCard function that was missing
        function addCard(sectionId, title, link, icon) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;

            const formattedLink = link.match(/^https?:\/\//) ? link : `http://${link}`;

            const newCard = {
                id: generateId(),
                title: title,
                link: formattedLink,
                icon: selectedIcon ? selectedIcon : null
            };

            section.cards.push(newCard);
            renderDashboard();
        }

        // Add the removeCard function that was missing
        function removeCard(sectionId, cardId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;
            
            section.cards = section.cards.filter(card => card.id !== cardId);
            renderDashboard();
        }

        // Add the editCard function that was missing
        function editCard(sectionId, cardId, updates) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;
            
            const card = section.cards.find(c => c.id === cardId);
            if (!card) return;
            
            Object.assign(card, updates);
            renderDashboard();
        }

        // Add icon search functionality
        let iconIndex = null;
        let selectedIcon = null;

        // Load icon index immediately
        async function loadIconIndex() {
            try {
                console.log('Attempting to load icon index...');
                const response = await fetch('assets/icon-index.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Successfully loaded icon index:', data);
                iconIndex = data.icons;
            } catch (error) {
                console.error('Error loading icon index:', error);
            }
        }

        function setupIconSearch(addCardForm) {
            const iconSearchInput = addCardForm.querySelector('[name="iconSearch"]');
            const searchResults = addCardForm.querySelector('.icon-search-results');
            const iconPreview = addCardForm.querySelector('.icon-preview');
            
            console.log('Icon Search Setup:', {
                form: addCardForm,
                input: iconSearchInput,
                results: searchResults,
                preview: iconPreview
            });

            let debounceTimeout;

            iconSearchInput.addEventListener('input', (e) => {
                const value = e.target.value.trim().toLowerCase();
                console.log('Input Event:', {
                    rawValue: e.target.value,
                    trimmedValue: value,
                    iconIndexExists: !!iconIndex,
                    iconIndexLength: iconIndex ? iconIndex.length : 0
                });
                
                // Clear previous timeout
                if (debounceTimeout) {
                    clearTimeout(debounceTimeout);
                }
                
                // Clear previous results
                searchResults.innerHTML = '';
                
                // Handle URL input
                if (value.startsWith('http')) {
                    console.log('URL detected, showing preview');
                    selectedIcon = { type: 'url', value: value };
                    iconPreview.innerHTML = `
                        <img src="${value}" 
                             alt="Icon preview"
                             onerror="this.style.display='none'"
                             onload="this.style.display='block'">
                    `;
                    searchResults.style.display = 'none';
                    return;
                }

                // Debounce search
                debounceTimeout = setTimeout(() => {
                    console.log('Debounced Search:', {
                        searchValue: value,
                        valueLength: value.length,
                        iconIndex: iconIndex
                    });

                    // Handle icon search
                    if (value.length < 2 || !iconIndex) {
                        console.log('Search skipped:', {
                            reason: value.length < 2 ? 'Too short' : 'No icon index',
                            valueLength: value.length,
                            hasIconIndex: !!iconIndex
                        });
                        searchResults.style.display = 'none';
                        return;
                    }

                    // Search icons
                    const matches = iconIndex.filter(icon => {
                        const nameMatch = icon.name.includes(value);
                        const keywordMatch = icon.keywords.some(k => k.includes(value));
                        console.log('Checking icon:', {
                            iconName: icon.name,
                            searchValue: value,
                            nameMatch: nameMatch,
                            keywordMatch: keywordMatch,
                            keywords: icon.keywords
                        });
                        return nameMatch || keywordMatch;
                    });

                    console.log('Search Results:', {
                        searchValue: value,
                        matchCount: matches.length,
                        matches: matches
                    });

                    if (matches.length > 0) {
                        searchResults.style.display = 'block';
                        matches.slice(0, 5).forEach(async icon => {
                            try {
                                console.log('Attempting to load SVG:', icon.path);
                                // Try with and without the 'assets/' prefix
                                let svgContent;
                                try {
                                    const response = await fetch(icon.path);
                                    if (!response.ok) {
                                        throw new Error('Failed with assets/ prefix');
                                    }
                                    svgContent = await response.text();
                                } catch (e) {
                                    console.log('Trying without assets/ prefix...');
                                    const response = await fetch(icon.path.replace('assets/', ''));
                                    svgContent = await response.text();
                                }
                                
                                console.log('Successfully loaded SVG content');
                                
                                const resultDiv = document.createElement('div');
                                resultDiv.className = 'icon-search-result';
                                resultDiv.innerHTML = `
                                    <div class="icon-preview-small">
                                        ${svgContent}
                                    </div>
                                    <span>${icon.name}</span>
                                `;
                                
                                resultDiv.addEventListener('click', () => {
                                    console.log('Icon selected:', icon.name);
                                    selectedIcon = { type: 'svg', value: svgContent };
                                    iconPreview.innerHTML = svgContent;
                                    iconSearchInput.value = icon.name;
                                    searchResults.style.display = 'none';
                                });
                                
                                searchResults.appendChild(resultDiv);
                            } catch (error) {
                                console.error('Error loading SVG:', {
                                    path: icon.path,
                                    error: error.message
                                });
                            }
                        });
                    } else {
                        console.log('No matches found');
                        searchResults.style.display = 'none';
                    }
                }, 300);
            });
        }
    </script>
</body>

</html>
